(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-242290d5"],{"9d38":function(e,t,a){"use strict";a.r(t);var r=a("7a23");function n(e,t,a,n,i,s){const c=Object(r["resolveComponent"])("his-standard-form");return Object(r["openBlock"])(),Object(r["createBlock"])(c,{skipSummary:!0,fields:e.fields,onFinishAction:e.onSubmit,cancelDestinationPath:e.cancelDestination},null,8,["fields","onFinishAction","cancelDestinationPath"])}var i=a("fe96"),s=Object(r["defineComponent"])({mixins:[i["a"]],watch:{ready:{async handler(e){e&&(this.fields=this.getAdherenceFields())},immediate:!0}},methods:{async onSubmit(){await this.saveAdherence(),this.nextTask()}}}),c=a("6b0d"),o=a.n(c);const u=o()(s,[["render",n]]);t["default"]=u},fe96:function(e,t,a){"use strict";var r=a("7a23"),n=a("d95e"),i=a("b5e4"),s=a("1da1"),c=a("d4ec"),o=a("bee2"),u=a("262e"),d=a("2caf"),l=(a("96cf"),a("d3b7"),a("d81d"),a("4de4"),a("caad"),a("2532"),a("25f0"),a("cc6f")),h=a("9283"),p=a("2ef0"),b=a("32b3"),g=a("5a0c"),f=a.n(g),m=function(e){Object(u["a"])(a,e);var t=Object(d["a"])(a);function a(e,r){var n;return Object(c["a"])(this,a),n=t.call(this,e,68,r),n.lastDrugs=[],n.lastReceiptDate="",n}return Object(o["a"])(a,[{key:"loadPreviousDrugs",value:function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(){var t,a,r,n,i=this;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return t=new Date(this.date),t.setDate(t.getDate()-1),a=function(e){return h["b"].toStandardHisFormat(e)},e.next=5,l["a"].getJson("patients/".concat(this.patientID,"/drugs_received"),{date:a(t)});case 5:r=e.sent,r&&(this.lastReceiptDate=r.reduce((function(e,t){return!e||new Date(a(t.order.start_date))>new Date(e)?a(t.order.start_date):e}),null),n=b["a"].htnDrugReferences().map((function(e){return e.drug_id})),this.lastDrugs=r.filter((function(e){return!n.includes(e.drug["drug_id"])&&a(e.order.start_date)===i.lastReceiptDate})));case 7:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"getReceiptDate",value:function(){return this.lastReceiptDate}},{key:"getLastDrugs",value:function(){return this.lastDrugs}},{key:"receivedDrugsBefore",value:function(){return!Object(p["isEmpty"])(this.lastDrugs)}},{key:"buildPillCountObs",value:function(e,t){return this.buildValueNumber("Number of tablets brought to clinic",t,null,e)}},{key:"buildAdherenceObs",value:function(){var e=Object(s["a"])(regeneratorRuntime.mark((function e(t,a,r){var n;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,l["a"].getConceptID("Drug adherence",!0);case 2:return n=e.sent,e.abrupt("return",{concept_id:n,value_numeric:r,value_drug:a,value_modifier:"%",order_id:t,person_id:this.patientID,obs_datetime:l["a"].getSessionDate()});case 4:case"end":return e.stop()}}),e,this)})));function t(t,a,r){return e.apply(this,arguments)}return t}()},{key:"isAdherenceGood",value:function(e){return e>=95&&e<=105}},{key:"calculateAdherence",value:function(e,t,a){return Math.round(100*(e-t)/(e-a))}},{key:"calculateExpected",value:function(e,t,a,r){var n="QW"===r?"week":"day",i=this.calcTimeElapsed(a,n);return e-i*parseFloat(t.toString())}},{key:"calcTimeElapsed",value:function(e,t){return f()(this.date).diff(e,t)}},{key:"calculateUnaccountedOrMissed",value:function(e,t){var a=parseFloat(e)-parseFloat(t);return a<0?-1*a+" missed":a+" unacc"}}]),a}(l["a"]),v=a("7365"),y=a("2706"),D=Object(r["defineComponent"])({mixins:[v["a"]],data:()=>({adherence:{},drugObs:[],askReasonForPoorAdherence:!1,calculationAgreementObs:[]}),methods:{async saveAdherence(){await this.adherence.createEncounter();const e=await Promise.all([...this.drugObs,...this.calculationAgreementObs]),t=await this.adherence.saveObservationList(e);if(!t)return Object(i["e"])("Unable to save patient observations")},buildAdherenceReport(e){const t=this.adherence.getReceiptDate(),a=this.adherence.calcTimeElapsed(t,"day"),r=` Last visit: ${h["b"].toStandardHisDisplayFormat(t)} \n                (${a} Days Elapsed)`,n=[{indexes:[0,3,6],class:"adherence-col-bg"}],i=[],s=[r],c=[["Prescription"],["Tabs given"],["Tabs per"],["Tabs remaining"],["Expected"],["Actual (counted)"],["Adherence"],["Doses missed/ Unaccounted for"],["Doses consumed"],["Art Adherence"]];return e.forEach((e,t)=>{const a=this.formatFrequency(e.frequency),r=this.calcPillsExpected(e),n=this.adherence.calculateAdherence(e.quantity,e.pillsBrought,r),o=this.adherence.isAdherenceGood(n)?"Good adherence":"Explore problem",u=this.adherence.calculateUnaccountedOrMissed(r,e.pillsBrought);s.push(e.drug.name),c[0].push(""),c[1].push(e.quantity),c[2].push(`${e.equivalent_daily_dose} <b>${a}</b>`),c[3].push(""),c[4].push(r<0?0:r),c[5].push(e.pillsBrought),c[6].push(""),c[7].push(u),c[8].push(n+"%"),c[9].push(o),i.push({index:t+1,row:9,class:o.match(/good/i)?"adherence-txt-good":"adherence-txt-bad"})}),[{label:"Selected Medication",value:"Table",other:{columns:s,rows:c,rowColors:n,cellColors:i}}]},formatFrequency(e){return(""+e).match(/qod/i)?"QOD":(""+e).match(/weekly/i)?"QW":e},calcPillsExpected(e){return this.adherence.calculateExpected(e.quantity,e.equivalent_daily_dose,e.order.start_date,this.formatFrequency(e.frequency))},getAdherenceFields(e=!1){return[{id:"pills_brought",helpText:"Pills remaining (brought to clinic)",type:n["b"].TT_ADHERENCE_INPUT,init:async()=>(this.adherence=new m(this.patientID,this.providerID),await this.adherence.loadPreviousDrugs(),!0),condition:()=>!e||this.adherence.receivedDrugsBefore(),validation:e=>{if(y["a"].required(e))return["No drugs available"];const t=e.map(e=>""===e.value);return t.some(Boolean)?["Some values are missing"]:null},unload:async e=>{this.drugObs=[],e.forEach(async e=>{const{drug:t,order:a}=e.other,r={...e.other,pillsBrought:e.value},n=this.adherence.calculateAdherence(r.quantity,r.pillsBrought,this.calcPillsExpected(r));this.drugObs.push(this.adherence.buildAdherenceObs(a.order_id,t.drug_id,n)),this.drugObs.push(this.adherence.buildPillCountObs(a.order_id,e.value)),this.askReasonForPoorAdherence||(this.askReasonForPoorAdherence=!this.adherence.isAdherenceGood(r))})},options:e=>Object(p["isEmpty"])(e.pills_brought)?this.adherence.getLastDrugs().map(e=>({label:e.drug.name,value:"",other:{...e}})):e.pills_brought},{id:"adherence_report",helpText:"ART adherence",type:n["b"].TT_TABLE_VIEWER,condition:()=>!e||this.adherence.receivedDrugsBefore(),options:e=>this.buildAdherenceReport(e.pills_brought.map(e=>({...e.other,pillsBrought:e.value}))),config:{hiddenFooterBtns:["Clear"]}},{id:"agree_with_calculation",helpText:"Agree with adherence calculation",type:n["b"].TT_SELECT,condition:()=>this.askReasonForPoorAdherence,validation:e=>y["a"].required(e),unload:({value:e})=>{this.calculationAgreementObs=[this.adherence.buildValueCoded("Reason for poor treatment adherence",e)]},options:()=>[{label:"Yes",value:"Yes"},{label:"No",value:"No"}]}]}}});const _=D;t["a"]=_}}]);
//# sourceMappingURL=chunk-242290d5.1fe0a870.js.map