var oe=Object.defineProperty;var re=(s,t,e)=>t in s?oe(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var l=(s,t,e)=>(re(s,typeof t!="symbol"?t+"":t,e),e);import{ax as S,G as ce,d as ue,ay as $,i as le,j as de,k as pe,I as ge,aw as ve,g as _e,r as v,ae as x,H as W,a2 as me,az as k,L as E,h as D,w as R,o as I,a as ye,T as he,aA as fe,y as be}from"./index-a3998c4f.js";import{A as u,S as Te,P as z,V as we,C as De}from"./ApiStore-d6b440c2.js";import{a as Ie,t as M}from"./toasts-a4a73cee.js";import{l as P}from"./loader-9bbe4f46.js";import{P as J,C as Se}from"./index-95d3a767.js";import{O as U,C as L,a as b}from"./form-6d9e4a71.js";import{e as Q}from"./encounter_types-55fa45e3.js";import{i as j,g as Ce}from"./common-94ac9539.js";import{E as q,a as K}from"./emc_event-4721851b.js";import{_ as Ae}from"./_plugin-vue_export-helper-c27b6911.js";class Y{constructor(t,e){l(this,"encounterTypeID");l(this,"programID");l(this,"encounterID");l(this,"providerID");l(this,"patientID");l(this,"date");this.encounterTypeID=9,this.patientID=t,this.encounterID=0,this.date=this.getSessionDate(),this.providerID=e,this.programID=J}getSessionDate(){return sessionStorage.getItem("sessionDate")||""}async createEncounter(){var n;const t={encounter_type_id:this.encounterTypeID,patient_id:this.patientID,encounter_datetime:this.date,program_id:this.programID},a=(await S.create(t)).data;if(a)return this.encounterID=(n=a.encounter_id)!=null?n:0,a}static async resetSessionDate(){const t=await this.getApiDate();if(console.log("HERE IS THE API DATE",t),t){sessionStorage.removeItem("apiDate"),sessionStorage.setItem("sessionDate",t);return}throw"Unable to reset session date"}static async getApiDate(){const t=await ce.getDate();if(t)return t.date}saveObservationList(t){return U.saveObsArray(this.encounterID,t)}async saveValueTextObs(t,e){const a=await U.buildValueText(t,e);return this.saveObs(a)}saveObs(t){return u.saveObs(this.encounterID,t)}buildValueText(t,e){return u.buildValueText(t,e,this.date)}buildGroupValueCoded(t,e,a){return u.buildGroupValueCoded(t,e,a,this.date)}buildValueDate(t,e){return u.buildValueDate(t,e,this.date)}buildValueNumber(t,e,a=null,n=null){return u.buildValueNumber(t,e,a,n,this.date)}buildValueCoded(t,e){return u.buildValueCoded(t,e,this.date)}setDate(t){this.date=t}}class Oe extends u{constructor(e,a){super(e,5,a);l(this,"patientType");l(this,"locationName");this.patientType="N/A",this.locationName=""}setLocationName(e){this.locationName=e}setPatientType(e){this.patientType=e}getType(){return this.patientType}static getPatientTypes(){return L.getConceptsByCategory("art_patient_type").map(({name:e})=>({label:e,value:e}))}static async isDrugRefillPatient(e){const a=await u.getFirstValueCoded(e,"Type of patient");return a&&a==="Emergency supply"}async loadPatientType(){const e=await this.getFirstValueCoded("Type of patient");e&&(this.patientType=e)}async save(){await this.savePatientType(this.patientType),this.locationName&&["External consultation","Emergency supply"].includes(this.patientType)&&await this.saveLocationClinic(this.locationName)}saveLocationClinic(e){return this.saveValueTextObs("Art clinic location",e)}savePatientType(e){return this.saveValueCodedObs("Type of patient",e)}}class Ve extends u{constructor(e,a,n){super(e,Q.HIV_STAGING,n);l(this,"age");l(this,"confirmatoryTest");this.age=a,this.confirmatoryTest=null}isAdult(){return this.age>=15}cd4CountIsValid(e){try{return!!e.match(/^(=|<|>)([0-9]*)$/m)}catch(a){return!1}}getStagingConditions(e){const a=this.getStagingCategoryByNum(e);return u.getConceptsByCategory(a)}getAllWhoStages(){return u.getConceptsByCategory("whole_staging_numbers")}getAllReasonsForART(e=this.date,a=!1){return u.getConceptsByCategory("reason_for_art").filter(n=>!(new Date(e)>new Date(Se)&&n.name.match(/cd4/i)||a&&n.name.match(/breastfeeding|pregnant/i)))}buildWhoStageObs(e){return this.buildValueCoded("Who stage",e)}buildWhoCriteriaObs(e){return this.buildValueCoded("Who stages criteria present",e)}buildReasonForArtObs(e){return this.buildValueCoded("Reason for ART eligibility",e)}getStagingCategoryByNum(e){switch(e){case 1:return this.isAdult()?"stage_1_conditions_adults":"stage_1_conditions_pedaids";case 2:return this.isAdult()?"stage_2_conditions_adults":"stage_2_conditions_pedaids";case 3:return this.isAdult()?"stage_3_conditions_adults":"stage_3_conditions_pedaids";case 4:return this.isAdult()?"stage_4_conditions_adults":"stage_4_conditions_pedaids";default:return""}}}const Ne=ue({components:{ClinicRegistration:$(()=>k(()=>import("./ClinicRegistration-514ca100.js"),["assets/ClinicRegistration-514ca100.js","assets/index-a3998c4f.js","assets/index-8b885fd4.css","assets/patient_service-6ec83e3a.js","assets/patient_identifier_service-841f15bb.js","assets/his_date-05fd283a.js","assets/index-95d3a767.js","assets/common-94ac9539.js","assets/TextInput-46ea36e4.js","assets/_plugin-vue_export-helper-c27b6911.js","assets/TextInput-e777cfa6.css","assets/DateInput-f08f26ee.js","assets/validations-11aef89d.js","assets/emc_event-4721851b.js","assets/vue-datepicker-c019a7dc.js","assets/DateInput-5fa0484d.css","assets/YesNoInput-4b80d294.js","assets/SelectInput-a2d652cc.js","assets/SelectInput-5e7944e5.css","assets/location_options-a54d2efb.js","assets/regimen_service-0c851836.js","assets/DTFormElements-a1199b88.js","assets/ApiStore-d6b440c2.js","assets/program_service-de5a3cd5.js","assets/image-cb93bc3e.js","assets/program_service-1ed4f047.css","assets/form-6d9e4a71.js","assets/Strs-7ee8a435.js","assets/Date-0dd82718.js","assets/toasts-a4a73cee.js","assets/loader-9bbe4f46.js","assets/user_service-56799831.js","assets/services-f7c3fb9d.js","assets/encounter_types-55fa45e3.js"])),Staging:$(()=>k(()=>import("./Staging-f0703787.js"),["assets/Staging-f0703787.js","assets/index-a3998c4f.js","assets/index-8b885fd4.css","assets/Date-0dd82718.js","assets/his_date-05fd283a.js","assets/TextInput-46ea36e4.js","assets/_plugin-vue_export-helper-c27b6911.js","assets/TextInput-e777cfa6.css","assets/DateInput-f08f26ee.js","assets/validations-11aef89d.js","assets/common-94ac9539.js","assets/emc_event-4721851b.js","assets/vue-datepicker-c019a7dc.js","assets/DateInput-5fa0484d.css","assets/YesNoInput-4b80d294.js","assets/SelectInput-a2d652cc.js","assets/SelectInput-5e7944e5.css","assets/location_options-a54d2efb.js","assets/form-6d9e4a71.js","assets/Strs-7ee8a435.js","assets/toasts-a4a73cee.js","assets/loader-9bbe4f46.js","assets/ApiStore-d6b440c2.js","assets/program_service-de5a3cd5.js","assets/image-cb93bc3e.js","assets/index-95d3a767.js","assets/program_service-1ed4f047.css","assets/user_service-56799831.js","assets/patient_service-6ec83e3a.js","assets/patient_identifier_service-841f15bb.js","assets/services-f7c3fb9d.js","assets/encounter_types-55fa45e3.js","assets/Staging-bd4ab211.css"])),IonGrid:le,IonRow:de,IonCol:pe,IonButton:ge},setup(){const s=ve(),t=_e(),e=v(!1),a=x({}),n=v("ClinicRegistration"),c=parseInt(s.params.patientId.toString()||""),_=!!s.params.new.toString().match(/true/i),C=W(()=>n.value==="Staging"),A=W(()=>n.value==="Staging"),T=v({}),y=v(""),F=v(""),w=v([]),O=x({}),G=v(!1),X=()=>{new z(c).getPrograms().then(i=>{const d=i.data;G.value=d.some(o=>o.program.name==="HIV PROGRAM")})},Z=r=>a[r.type]=r.data,ee=()=>n.value="Staging",te=()=>n.value="ClinicRegistration",ae=async()=>{const{arvNumberEditable:r,formData:i,computedData:d}=a.registration,{computedData:o}=a.staging;try{if(P.show(),!_&&!j(w.value))for(const g of w.value)await S.void(g,"Duplicate");r&&i.arvNumber&&await T.value.createArvNumber(i.arvNumber);const p=new Oe(c,-1);await p.createEncounter();const V=await b(d,"patient type");await p.saveObservationList(V);const m=new Y(c,-1);await m.createEncounter();const N=await b(d,"registration");if(await m.saveObservationList(N),i.everRegisteredAtClinic==="Yes"){const g=new we(c,-1);await g.createEncounter();const se=await b(d,"vitals");await g.saveObservationList(se);const B=new De(c,-1);await B.createEncounter();const ne=await b(d,"consultation");await B.saveObservationList(ne)}const h=new Ve(c,T.value.getAge(),-1);await h.createEncounter();const f=await b(o);if(await h.saveObservationList(f),_||!G.value){const g=new z(c);g.setProgramDate(i.initialVisitDate),await g.enrollProgram()}await P.hide(),await Y.resetSessionDate(),await Ie("Saved successfully"),t.push("/patient/".concat(c))}catch(p){await P.hide(),console.log(p),M("".concat(p))}},H=async r=>{for(const i of r){w.value.includes(i.encounter_id)||w.value.push(i.encounter_id);const d=await L.getConceptName(i.concept_id);let o="";i.value_datetime||i.value_drug?o=i.value_datetime:i.value_text?o=i.value_text:i.value_numeric?o=i.value_numeric:i.value_coded&&(o=await L.getConceptName(i.value_coded)),i.value_modifier&&(o=i.value_modifier+o),O[d]=o}},ie=async()=>{const{HIV_CLINIC_CONSULTATION:r,HIV_CLINIC_REGISTRATION:i,REGISTRATION:d,HIV_STAGING:o,VITALS:p}=Q;try{const m=(await S.all({encounter_type_id:i,patient_id:c})).data;if(j(m))return;if(y.value=Ce(m,"[0].encounter_datetime",""),y.value){await H(m[0].observations);const N=(await S.all({program_id:J,patient_id:c,date:y.value})).data||[];for(const h of N){let f=[d,o];/yes/i.test("".concat(O["Ever registered at ART clinic"]))&&(f=[...f,r,p]),f.includes(h.encounter_type)&&await H(h.observations)}}}catch(V){M("Unable to load previous observations")}};return me(async()=>{X(),T.value=await Te.get("ACTIVE_PATIENT",{patientID:c}),_||await ie(),e.value=!0,q.on(K.ON_INITIAL_VISIT_DATE,r=>{y.value=r}),q.on(K.ON_ART_START_DATE,r=>{F.value=r})}),{activeForm:n,patient:T,isNewPatient:_,isStaging:C,isRegistration:A,isReady:e,initialVisitDate:y,observations:O,artStartDate:F,onValue:Z,onFinish:ae,onNext:ee,onPrevious:te}}});function Ee(s,t,e,a,n,c){const _=E("ion-col"),C=E("ion-row"),A=E("ion-grid");return I(),D(A,null,{default:R(()=>[ye(C,{class:"his-card"},{default:R(()=>[s.isReady?(I(),D(_,{key:0,size:"12"},{default:R(()=>[(I(),D(he,null,[(I(),D(fe(s.activeForm),{patient:s.patient,isNewPatient:s.isNewPatient,initialVisitDate:s.initialVisitDate,artStartDate:s.artStartDate,observations:s.observations,onOnValue:s.onValue,onOnNext:s.onNext,onOnPrevious:s.onPrevious,onOnFinish:s.onFinish},null,40,["patient","isNewPatient","initialVisitDate","artStartDate","observations","onOnValue","onOnNext","onOnPrevious","onOnFinish"]))],1024))]),_:1})):be("",!0)]),_:1})]),_:1})}const Re=Ae(Ne,[["render",Ee]]),Me=Object.freeze(Object.defineProperty({__proto__:null,default:Re},Symbol.toStringTag,{value:"Module"}));export{Y as C,Me as H,Oe as P,Ve as S};
